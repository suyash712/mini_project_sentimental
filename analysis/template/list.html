<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://getbootstrap.com/docs/5.3/assets/css/docs.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <title>Meeting Website</title>
    <link rel="stylesheet" href="static/list.css">
    <style>
        .container {
            max-width: 1200px;
            height: auto; 
            overflow: visible; 
        }
        .modal-content {
            max-height: 90vh; 
            overflow-y: auto; 
        }
        .table-responsive {
            overflow-x: auto; 
        }
        .modal-lg {
            max-width: 900px;
        }
        .chart-container {
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 10px;
            height: 250px;
            margin-bottom: 20px;
        }
        .chart-heading {
            text-align: center;
            font-size: 14px;
            margin-bottom: 5px;
            color: #495057;
        }
        .chart-wrapper {
            height: 200px;
        }
        .emotion-summary {
            background-color: #e9ecef;
            border-left: 4px solid #007bff;
        }
        .emotion-summary p {
            margin-bottom: 0;
        }
        .lead {
            font-size: 1rem;
            font-weight: 500;
        }
        .description-box {
            background-color: #f0f0f0;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            text-align: center;
            color: #333;
        }
    </style>
</head>
<body>
<header>
    <nav class="navbar">
        <div class="container">
            <div class="logo">EmoTrack</div>
            <ul class="nav-links">
                <li><a href="http://127.0.0.1:8000/home">HOME</a></li>
                <li><a href="http://127.0.0.1:8000/list">MEETING</a></li>
                <li><a href="http://127.0.0.1:8000/meetlist">LIST</a></li>
                <li><a href="#login" class="login-btn">Login</a></li>
            </ul>
            <div class="menu-toggle" id="menu-toggle">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
        </div>
    </nav>
</header>

<div class="heading">
    <h1><span class="badge rounded-pill text-bg-info">EMO-TRACK</span></h1>
    <input type="text" id="searchInput" placeholder="Search.." style="margin-left: 700px;">
    <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" style="margin-left: 10px;">
          sort
        </button>
        <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" onclick="sortTable('date')">by date</a></li>
            <li><a class="dropdown-item" href="#" onclick="sortTable('username')">by username</a></li>
            <li><a class="dropdown-item" href="#" onclick="sortTable('meetingId')">by meeting id</a></li>
          </ul>
      </div>
      
</div>

<div class="container" style="max-width: 1200px; overflow: auto;">
    <div class="table-responsive">
        <table class="table table-bordered table-hover" id="meetingTable">
            <thead class="table-dark">
                <tr>
                    <th>No.</th>
                    <th>Meeting ID</th>
                    <th>Topic</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody>
                {% for meeting in completed_meetings %}
                <tr>
                    <td>
                        <div type="button" class="meeting-row" data-id="{{ meeting.meeting_id }}" data-bs-toggle="modal" data-bs-target="#reportModal">{{ forloop.counter }}</div>
                    </td>
                    <td>
                        <div type="button" class="meeting-row" data-id="{{ meeting.meeting_id }}" data-bs-toggle="modal" data-bs-target="#reportModal">{{ meeting.meeting_id }}</div>
                    </td>
                    <td>
                        <div type="button" class="meeting-row" data-id="{{ meeting.meeting_id }}" data-bs-toggle="modal" data-bs-target="#reportModal">{{ meeting.meeting_topic }}</div>
                    </td>
                    <td>
                        <div type="button" class="meeting-row" data-id="{{ meeting.meeting_id }}" data-bs-toggle="modal" data-bs-target="#reportModal">{{ meeting.start_time }}</div>
                    </td>
                </tr>g
                {% empty %}
                <tr>
                    <td colspan="4" class="text-center">No completed meetings found.</td>
                </tr>
                
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="reportModalLabel">Interview Sentiment Analysis Report</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <span class="badge text-bg-primary">{{meeting.meeting_id}}</span>
                <div class="container-fluid">
                    <!-- 2x2 Graph Layout -->
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="chart-container">
                                <h6 class="chart-heading">Confidence Level Over Time</h6>
                                <canvas id="confidenceChart"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="chart-container">
                                <h6 class="chart-heading">Emotional Breakdown</h6>
                                <canvas id="emotionPieChart"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="chart-container">
                                <h6 class="chart-heading">Nervousness Over Interview Duration</h6>
                                <canvas id="nervousnessChart"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="chart-container">
                                <h6 class="chart-heading">Positive vs Negative Emotion Ratio</h6>
                                <canvas id="positiveNegativeChart"></canvas>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="chart-container" style="position: relative; height:60vh; width:100%">
                                <canvas id="emotionChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>



<footer class="footer">
    <div class="container">
        <div class="footer-logo">
            <h2>MeetingSite</h2>
            <p>Connecting people, one meeting at a time.</p>
        </div>
        <div class="footer-links">
            <div class="footer-section">
                <h3>Quick Links</h3>
                <ul>
                    <li><a href="#schedule">Schedule</a></li>
                    <li><a href="#join">Join</a></li>
                    <li><a href="#host">Host</a></li>
                    <li><a href="#contact">Contact</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>About Us</h3>
                <ul>
                    <li><a href="#about">Company</a></li>
                    <li><a href="#careers">Careers</a></li>
                    <li><a href="#privacy">Privacy Policy</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>Follow Us</h3>
                <ul class="social-media">
                    <li><a href="#" class="social-icon"><i class="fab fa-facebook-f"></i></a></li>
                    <li><a href="#" class="social-icon"><i class="fab fa-twitter"></i></a></li>
                    <li><a href="#" class="social-icon"><i class="fab fa-linkedin-in"></i></a></li>
                    <li><a href="#" class="social-icon"><i class="fab fa-instagram"></i></a></li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2024 MeetingSite. All rights reserved.</p>
        </div>
    </div>
</footer>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script>
    // Global chart object
let emotionChart;

document.querySelectorAll('.meeting-row').forEach(row => {
    row.addEventListener('click', function() {
        const meetingId = this.getAttribute('data-id');
        
        fetch(`/get-emotion-data/${meetingId}/`)
            .then(response => response.json())
            .then(data => {
                updateEmotionChart('emotionChart', data.emotions);
            });
    });
});

function updateEmotionChart(canvasId, emotions) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    
    // Prepare data
    const emotionTypes = [...new Set(emotions.map(e => e.emotion))];
    const datasets = emotionTypes.map(emotion => ({
        label: emotion,
        data: emotions.filter(e => e.emotion === emotion).map(e => ({
            x: e.timestamp * 1000, // Convert to milliseconds
            y: e.intensity
        })),
        borderColor: getColorForEmotion(emotion),
        fill: false,
        tension: 0.1
    }));

    // Destroy existing chart if it exists
    if (emotionChart) {
        emotionChart.destroy();
    }
    
    // Create new chart
    emotionChart = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'second',
                        displayFormats: {
                            second: 'HH:mm:ss'
                        }
                    },
                    title: {
                        display: true,
                        text: 'Time'
                    }
                },
                y: {
                    beginAtZero: true,
                    max: 1,
                    title: {
                        display: true,
                        text: 'Intensity'
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Emotion Intensity Over Time'
                },
                legend: {
                    display: true,
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        title: function(tooltipItems) {
                            return new Date(tooltipItems[0].parsed.x).toLocaleString();
                        }
                    }
                }
            }
        }
    });
}

function getColorForEmotion(emotion) {
    const colorMap = {
        'Confidence': 'rgb(54, 162, 235)',
        'Nervousness': 'rgb(255, 99, 132)',
        'Happiness': 'rgb(255, 206, 86)',
        'Sadness': 'rgb(75, 192, 192)',
        'Anger': 'rgb(255, 159, 64)',
        'Surprise': 'rgb(153, 102, 255)'
    };
    return colorMap[emotion] || `rgb(${Math.floor(Math.random()*255)}, ${Math.floor(Math.random()*255)}, ${Math.floor(Math.random()*255)})`;
}

// Update chart when modal is shown
$('#reportModal').on('shown.bs.modal', function () {
    if (emotionChart) emotionChart.update();
});
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="static/list.js"></script>

<script>
    // Search functionality
    document.getElementById('searchInput').addEventListener('keyup', function() {
        let searchQuery = this.value.toLowerCase();
        let table = document.getElementById('meetingTable');
        let rows = table.getElementsByTagName('tr');

        for (let i = 1; i < rows.length; i++) {
            let row = rows[i];
            let rowData = row.textContent.toLowerCase();
            if (rowData.includes(searchQuery)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        }
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>


<script src="list.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<!-- Chart.js Logic -->
<script>
    // Emotion mapping to confidence and nervousness levels
const emotionMapping = {
    'Sad': { confidence: 0.3, nervousness: 0.7 },
    'Neutral': { confidence: 0.5, nervousness: 0.5 },
    'Happy': { confidence: 0.8, nervousness: 0.2 },
    'Angry': { confidence: 0.6, nervousness: 0.8 },
    'Surprised': { confidence: 0.4, nervousness: 0.6 },
    'Fearful': { confidence: 0.2, nervousness: 0.9 },
    'Disgusted': { confidence: 0.4, nervousness: 0.7 },
    // Add more emotions as needed
};

// Function to process emotion data
function processEmotionData(emotions) {
    return emotions.map(e => ({
        timestamp: e.timestamp,
        confidence: (emotionMapping[e.emotion]?.confidence || 0.5) * e.intensity,
        nervousness: (emotionMapping[e.emotion]?.nervousness || 0.5) * e.intensity,
        originalEmotion: e.emotion,
        intensity: e.intensity
    }));
}

// Function to calculate rolling average
function calculateRollingAverage(data, windowSize = 5) {
    return data.map((val, index, array) => {
        const start = Math.max(0, index - windowSize + 1);
        const window = array.slice(start, index + 1);
        return window.reduce((sum, curr) => sum + curr, 0) / window.length;
    });
}

// Function to update charts
function updateCharts(emotions) {
    const processedData = processEmotionData(emotions);
    const timestamps = processedData.map(d => d.timestamp);
    
    const confidenceData = processedData.map(d => d.confidence);
    const nervousnessData = processedData.map(d => d.nervousness);
    
    const rollingConfidence = calculateRollingAverage(confidenceData);
    const rollingNervousness = calculateRollingAverage(nervousnessData);
    
    updateChart('confidenceChart', timestamps, rollingConfidence, 'Confidence Level (Inferred)');
    updateChart('nervousnessChart', timestamps, rollingNervousness, 'Nervousness Level (Inferred)');
    
    // Update other charts
    updateEmotionalBreakdownChart(emotions);
    updatePositiveNegativeRatioChart(emotions);
}

// Function to update a single chart
function updateChart(canvasId, labels, data, label) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: label,
                data: data,
                borderColor: label.includes('Confidence') ? 'blue' : 'red',
                borderWidth: 2,
                fill: false
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    type: 'linear',
                    position: 'bottom',
                    title: {
                        display: true,
                        text: 'Time (seconds)'
                    }
                },
                y: {
                    beginAtZero: true,
                    max: 1,
                    title: {
                        display: true,
                        text: 'Level'
                    }
                }
            }
        }
    });
}

// Update this part in your existing click event listener
document.querySelectorAll('.meeting-row').forEach(row => {
    row.addEventListener('click', function() {
        const meetingId = this.getAttribute('data-id');
        
        fetch(`/get-emotion-data/${meetingId}/`)
            .then(response => response.json())
            .then(data => {
                updateCharts(data.emotions);
            });
    });
});

// Function to update the Emotional Breakdown chart
function updateEmotionalBreakdownChart(emotions) {
    const emotionCounts = emotions.reduce((acc, e) => {
        acc[e.emotion] = (acc[e.emotion] || 0) + 1;
        return acc;
    }, {});

    const ctx = document.getElementById('emotionPieChart').getContext('2d');
    new Chart(ctx, {
        type: 'pie',
        data: {
            labels: Object.keys(emotionCounts),
            datasets: [{
                data: Object.values(emotionCounts),
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF'
                ]
            }]
        },
        options: {
            responsive: true,
            title: {
                display: true,
                text: 'Emotional Breakdown'
            }
        }
    });
}

// Function to update the Positive vs Negative Emotion Ratio chart
function updatePositiveNegativeRatioChart(emotions) {
    const positiveEmotions = ['Happy', 'Surprised'];
    const negativeEmotions = ['Sad', 'Angry', 'Fearful', 'Disgusted'];
    
    const positiveCount = emotions.filter(e => positiveEmotions.includes(e.emotion)).length;
    const negativeCount = emotions.filter(e => negativeEmotions.includes(e.emotion)).length;
    const neutralCount = emotions.length - positiveCount - negativeCount;

    const ctx = document.getElementById('positiveNegativeChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Positive', 'Negative', 'Neutral'],
            datasets: [{
                data: [positiveCount, negativeCount, neutralCount],
                backgroundColor: ['#4CAF50', '#F44336', '#FFC107']
            }]
        },
        options: {
            responsive: true,
            title: {
                display: true,
                text: 'Positive vs Negative Emotion Ratio'
            }
        }
    });
}
</script>
<script>$('#reportModal').on('shown.bs.modal', function () {
    confidenceChart.update(); 
    emotionPieChart.update(); 
    nervousnessChart.update(); 
    positiveNegativeChart.update();
});</script>

<script>
    function sortTable(sortBy) {
    let table = document.getElementById('meetingTable');
    let tbody = table.getElementsByTagName('tbody')[0];
    let rows = Array.from(tbody.getElementsByTagName('tr'));

    rows.sort((a, b) => {
        let aValue, bValue;

        if (sortBy === 'date') {
            aValue = new Date(a.cells[3].textContent);
            bValue = new Date(b.cells[3].textContent);
        } else if (sortBy === 'username') {
            aValue = a.cells[2].textContent.toLowerCase();
            bValue = b.cells[2].textContent.toLowerCase();
        } else if (sortBy === 'meetingId') {
            aValue = parseInt(a.cells[1].textContent);
            bValue = parseInt(b.cells[1].textContent);
        }

        if (aValue < bValue) return -1;
        if (aValue > bValue) return 1;
        return 0;
    });

    // Reorder the table
    rows.forEach(row => tbody.appendChild(row));
}
</script>
</body>
</html>
